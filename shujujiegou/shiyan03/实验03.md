# 实验03

## 运行结果

![image-20231030082559143](C:\Users\Baijy\AppData\Roaming\Typora\typora-user-images\image-20231030082559143.png)

![image-20231030082614251](C:\Users\Baijy\AppData\Roaming\Typora\typora-user-images\image-20231030082614251.png)

## 分析

在原有程序的基础上，要增加对script的验证，那么首要问题就是读入script.

读入之后，应该根据具体的情况来设计栈，进行栈操作并验证.

最后综合之前的代码，得到结果。

## 实现

### 读入数据

由于上一个实验忽略了script字段的读入，所以这次应该进行修改。

注意到部分数据有script，部分数据无，所以应该增加一个判断。

通过新增一个count辅助变量来进行判断。



### 验证操作

要以栈的方式实现，所以要先实现一个栈。

为便于操作，以类的方式实现，由于本实验不需要用到栈的所有相关函数，所以在实现栈时主要实现了以下几个必要操作：

* `empty()`判断是否为空。
* `top()`返回栈顶元素。
* `pop()`去掉栈顶元素。
* `push()`存入栈顶元素。

使用链式存储。

然后进行验证,进行入栈操作，边读边操作。

其中由于计算表达式比较复杂，且不想转为后缀表达式，所以增加一个判断优先级的函数，直接按照中缀表达式来操作，具体实现方案：

具体操作参考了：

* 使用两个栈，一个存放操作数，另一个存放操作符
  将表达式存入两个栈中，边存边计算
* 从左往右扫描表达式，遇到操作数则直接将其放入操作数栈。
  遇到操作符时，如果优先级低于或等于栈顶操作符优先级，则从操作数栈弹出两个元素进行计算，并将计算结果存入操作数栈，继续与栈顶操作符的比较优先级。
* 如果遇到操作符高于栈顶操作符优先级，则直接入操作符栈 ；遇到左括号，直接入操作符栈，遇到右括号，则直接出栈并计算，直到遇到左括号。
* 循环步骤3，直到表达式全部被扫描；若扫描完成后，操作符栈不为空，则依次将操作符栈的元素出栈，同时将操作数里面的元素出栈进行计算，同样将计算结果存入操作数栈，直到操作符栈为空，最后在操作数栈的栈顶元素就是表达式的最终计算结果。
  ————————————————
  参考原文链接：https://blog.csdn.net/qq_41032474/article/details/89715140

此外，`OP_CHECKSIG`操作需要调用`rsa.h`头文件，其中的验证操作会有多余输出，所以进入其中进行一些删除操作来吧多余的输出去掉。

别的就是按照作业说明文档中的提示按部就班操作即可。

为了和之前的代码相兼容，所以做了一些调整，用返回值-4来代表未通过script验证这种情况，返回对应报错。

